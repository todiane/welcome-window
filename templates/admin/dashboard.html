{% extends "base.html" %}
{% block body %}
<div class="min-h-screen bg-gray-50" x-data="adminDashboard()" x-init="init()">
    <div class="bg-white border-b px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Admin Dashboard</h1>
            <div class="flex gap-3">
                <a href="/" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">View Site</a>
                <a href="/admin/logout" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</a>
            </div>
        </div>
    </div>
    <div class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Active Visitors</div>
                <div class="text-3xl font-bold" x-text="Object.keys(activeConnections).length"></div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Pending Approvals</div>
                <div class="text-3xl font-bold text-orange-600" x-text="pendingCount"></div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Total Visits</div>
                <div class="text-3xl font-bold">{{ stats.total_visits }}</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Avg Duration</div>
                <div class="text-3xl font-bold">{{ stats.avg_duration_minutes }}m</div>
            </div>
        </div>
        
        <!-- Pending Approvals Section -->
        <div x-show="pendingCount > 0" class="bg-orange-50 border-2 border-orange-200 rounded-xl p-6 shadow mb-6">
            <h2 class="text-xl font-bold mb-4 text-orange-800">ðŸ”” Pending Access Requests</h2>
            <div class="space-y-3">
                <template x-for="visitor in pendingVisitors" :key="visitor.id">
                    <div class="bg-white rounded-lg p-4 border-2 border-orange-300">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold text-lg" x-text="visitor.name"></div>
                                <div class="text-sm text-gray-600" x-text="visitor.email"></div>
                                <div class="text-xs text-gray-400 mt-1" x-text="'Requested ' + new Date(visitor.requested_at).toLocaleString()"></div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="approveVisitor(visitor.id)" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                    âœ“ Approve
                                </button>
                                <button @click="rejectVisitor(visitor.id)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                                    âœ— Reject
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Availability Status</h2>
            <div class="flex gap-4 mb-4">
                <button @click="updateStatus('available', 'Available for a chat!')" :class="status==='available'?'bg-green-600 text-white':'bg-gray-200'" class="px-6 py-3 rounded-lg font-medium">Available</button>
                <button @click="updateStatus('busy', 'Busy right now')" :class="status==='busy'?'bg-yellow-600 text-white':'bg-gray-200'" class="px-6 py-3 rounded-lg font-medium">Busy</button>
                <button @click="updateStatus('away', 'Not available')" :class="status==='away'?'bg-red-600 text-white':'bg-gray-200'" class="px-6 py-3 rounded-lg font-medium">Away</button>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Status Message</label>
                <input type="text" x-model="statusMessage" @keyup.enter="updateStatus(status, statusMessage)" class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none">
                <button @click="updateStatus(status, statusMessage)" class="mt-3 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save Status</button>
            </div>
        </div>

        <!-- Live Chat Interface -->
        <div class="bg-white rounded-xl shadow mb-6">
            <div class="border-b p-4">
                <h2 class="text-xl font-bold">Live Chat</h2>
                <p class="text-sm text-gray-500">Real-time conversation with visitors</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3">
                <!-- Chat window -->
                <div class="lg:col-span-2 border-r">
                    <div class="h-96 overflow-y-auto p-4 space-y-3 bg-gray-50" id="admin-messages">
                        <template x-for="msg in chatMessages" :key="msg.id || (msg.timestamp + msg.sender_name)">
                            <div :class="msg.sender==='admin'?'text-right':'text-left'" class="group">
                                <div class="inline-block max-w-[80%] relative">
                                    <div class="text-xs mb-1" :class="msg.sender==='admin'?'text-blue-600':'text-gray-600'">
                                        <span x-text="msg.sender_name"></span>
                                        <span x-show="msg.visitor_id" x-text="' (' + msg.visitor_id.slice(0,8) + ')'"></span>
                                    </div>
                                    <div class="px-4 py-2 rounded-lg break-words relative" :class="msg.sender==='admin'?'bg-blue-600 text-white':'bg-white border-2'">
                                        <span x-text="msg.message"></span>
                                        <button 
                                            @click="deleteMessage(msg.id)" 
                                            x-show="msg.id"
                                            class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
                                            title="Delete message"
                                        >
                                            Ã—
                                        </button>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1" x-text="msg.created_at ? new Date(msg.created_at).toLocaleTimeString() : new Date(msg.timestamp).toLocaleTimeString()"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="chatMessages.length === 0" class="text-center text-gray-400 py-12">
                            No messages yet. Waiting for visitors to connect...
                        </div>
                    </div>
                    <div class="p-4 border-t bg-white">
                        <form @submit.prevent="sendAdminMessage()">
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    x-model="adminMessage" 
                                    placeholder="Type a message to all visitors..." 
                                    class="flex-1 px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                                    
                                >
                                <button 
                                    type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                    :disabled="!adminMessage.trim()"
                                >
                                    Send
                                </button>
                            </div>
                        </form>
                        <div class="flex justify-between items-center mt-2">
                            <div class="text-xs text-gray-500">
                                <span x-show="Object.keys(activeConnections).length > 0">Tip: Messages are broadcast to all <span x-text="Object.keys(activeConnections).length"></span> connected visitor(s)</span>
                                <span x-show="Object.keys(activeConnections).length === 0" class="text-orange-500">No visitors connected</span>
                            </div>
                            <button 
                                @click="clearChatHistory()" 
                                class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200"
                                x-show="chatMessages.length > 0"
                            >
                                Clear History
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Active visitors sidebar -->
                <div class="p-4">
                    <h3 class="font-bold mb-3">Active Visitors (<span x-text="Object.keys(activeConnections).length"></span>)</h3>
                    <div class="space-y-2">
                        <template x-for="[sid, conn] in Object.entries(activeConnections)" :key="sid">
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm" x-text="conn.visitor_name"></div>
                                        <div class="text-xs text-gray-500" x-text="'ID: ' + conn.visitor_id.slice(0, 12)"></div>
                                        <div class="text-xs text-gray-400 mt-1" x-text="'Connected ' + new Date(conn.connected_at).toLocaleTimeString()"></div>
                                    </div>
                                </div>
                                <button 
                                    @click="disconnectVisitor(conn.sid, conn.visitor_name)"
                                    class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 w-full"
                                >
                                    Disconnect
                                </button>
                            </div>
                        </template>
                        <div x-show="Object.keys(activeConnections).length === 0" class="text-center text-gray-400 py-4 text-sm">
                            No active visitors
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl p-6 shadow">
                <h2 class="text-xl font-bold mb-4">Guest Book</h2>
                <div class="space-y-3">
                    {% for msg in messages %}
                    <div class="border rounded-lg p-4 {% if not msg.is_read %}bg-blue-50{% endif %}">
                        <div class="flex justify-between mb-2">
                            <div class="font-medium">{{ msg.visitor_name or 'Anonymous' }}</div>
                            <div class="text-xs text-gray-500">{{ msg.created_at }}</div>
                        </div>
                        <div class="text-gray-700">{{ msg.message }}</div>
                        {% if not msg.is_read %}
                        <button onclick="fetch('/admin/messages/{{ msg.id }}/read',{method:'POST'}).then(()=>window.location.reload())" class="text-xs text-blue-600 mt-2 hover:underline">Mark read</button>
                        {% endif %}
                        <button onclick="if(confirm('Delete this message?')){fetch('/admin/messages/{{ msg.id }}/delete',{method:'POST'}).then(()=>window.location.reload())}" class="text-xs text-red-600 hover:underline">Delete</button>
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">No messages yet</div>
                    {% endfor %}
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <h2 class="text-xl font-bold mb-4">Recent Visits</h2>
                <div class="space-y-3">
                    {% for visit in visits %}
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between mb-1">
                            <div class="font-medium">{{ visit.visitor_name or 'Anonymous' }}</div>
                            <div class="text-xs text-gray-500">
                                {% if visit.duration_seconds %}{{ (visit.duration_seconds/60)|round(1) }}m{% else %}Active{% endif %}
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">{{ visit.started_at }}</div>
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">No visits yet</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function adminDashboard() {
    return {
        status: '{{ status.status }}',
        statusMessage: '{{ status.message }}',
        pendingCount: {{ pending_visitors|length }},
        pendingVisitors: {{ pending_visitors|tojson }},
        chatMessages: [],
        adminMessage: '',
        activeConnections: {},
        socket: null,
        
        init() {
            this.socket = io();
            this.socket.emit('join_admin');
            
            // Admin joined successfully
            this.socket.on('admin_joined', (data) => {
                console.log('Admin joined:', data);
                
                // Convert array to object keyed by sid
                this.activeConnections = {};
                if (data.active_connections) {
                    data.active_connections.forEach(conn => {
                        this.activeConnections[conn.sid] = {
                            sid: conn.sid,
                            visitor_id: conn.visitor_id,
                            visitor_name: conn.visitor_name,
                            connected_at: conn.connected_at
                        };
                    });
                }
                
                // Load chat history
                if (data.chat_history && data.chat_history.length > 0) {
                    this.chatMessages = data.chat_history.map(msg => ({
                        id: msg.id,
                        message: msg.message,
                        sender: msg.sender,
                        sender_name: msg.sender_name,
                        visitor_id: msg.visitor_id,
                        timestamp: msg.created_at,
                        created_at: msg.created_at
                    }));
                    
                    this.$nextTick(() => {
                        const container = document.getElementById('admin-messages');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                }
            });
            
            // New visitor joined
            this.socket.on('visitor_joined', (data) => {
                console.log('Visitor joined:', data);
                this.activeConnections[data.sid] = {
                    sid: data.sid,
                    visitor_id: data.visitor_id,
                    visitor_name: data.visitor_name,
                    connected_at: data.connected_at
                };
            });
            
            // Visitor left
            this.socket.on('visitor_left', (data) => {
                console.log('Visitor left:', data);
                delete this.activeConnections[data.sid];
            });
            
            // New message received
            this.socket.on('new_message', (data) => {
                console.log('New message received:', data);
                this.chatMessages.push(data);
                this.$nextTick(() => {
                    const container = document.getElementById('admin-messages');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                });
            });
            
            // New visitor request
            this.socket.on('new_visitor_request', (data) => {
                this.pendingVisitors.push(data);
                this.pendingCount++;
                if (Notification.permission === 'granted') {
                    new Notification('New Visitor Request', {
                        body: `${data.name} (${data.email}) is requesting access`,
                        icon: '/static/icon.png'
                    });
                }
            });

            // New guestbook message
            this.socket.on('new_guestbook_message', (data) => {
                if (Notification.permission === 'granted') {
                    new Notification('New Guestbook Message', {
                        body: `${data.name}: ${data.message}`,
                    });
                }
            });
            
            // Handle message deletion
            this.socket.on('message_deleted', (data) => {
                this.chatMessages = this.chatMessages.filter(msg => msg.id !== data.message_id);
            });
            
            // Handle chat cleared
            this.socket.on('chat_cleared', () => {
                this.chatMessages = [];
            });
                       // Poll for chat messages as fallback
            setInterval(async () => {
                try {
                    const response = await fetch('/admin/chat/messages');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.length !== this.chatMessages.length) {
                            this.chatMessages = data;
                            this.$nextTick(() => {
                                const container = document.getElementById('admin-messages');
                                if (container) container.scrollTop = container.scrollHeight;
                            });
                        }
                    }
                } catch (e) {}
            }, 2000);
            // Poll for pending visitors as fallback
            setInterval(async () => {
                try {
                    const response = await fetch('/admin/pending-visitors');
                    if (response.ok) {
                        const data = await response.json();
                        // Update if count changed
                        if (data.length !== this.pendingCount) {
                            this.pendingVisitors = data;
                            this.pendingCount = data.length;
                        }
                    }
                } catch (e) {}
            }, 3000);
            
            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        },
        
        updateStatus(status, message) {
            this.status = status;
            this.statusMessage = message;
            fetch('/admin/status/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status, message})
            });
        },
        
        sendAdminMessage() {
            if (!this.adminMessage.trim()) return;
            
            console.log('Sending admin message:', this.adminMessage);
            
            this.socket.emit('send_message', {
                message: this.adminMessage,
                sender: 'admin'
            });
            
            this.adminMessage = '';
        },
        
        async approveVisitor(visitorId) {
            try {
                await fetch(`/admin/visitor/${visitorId}/approve`, {method: 'POST'});
                this.pendingVisitors = this.pendingVisitors.filter(v => v.id !== visitorId);
                this.pendingCount--;
            } catch (error) {
                console.error('Error approving visitor:', error);
            }
        },
        
        async rejectVisitor(visitorId) {
            if (!confirm('Reject this visitor?')) return;
            try {
                await fetch(`/admin/visitor/${visitorId}/reject`, {method: 'POST'});
                this.pendingVisitors = this.pendingVisitors.filter(v => v.id !== visitorId);
                this.pendingCount--;
            } catch (error) {
                console.error('Error rejecting visitor:', error);
            }
        },
        
        async disconnectVisitor(sid, visitorName) {
            if (!confirm(`Disconnect ${visitorName}?`)) return;
            
            // Find the visitor_id by sid
            const conn = this.activeConnections[sid];
            if (!conn) return;
            
            try {
                const response = await fetch(`/admin/visitor/${conn.visitor_id}/disconnect`, {
                    method: 'POST'
                });
                if (response.ok) {
                    // Remove immediately from UI
                    delete this.activeConnections[sid];
                    console.log('Visitor disconnected');
                } else {
                    alert('Failed to disconnect visitor');
                }
            } catch (error) {
                console.error('Error disconnecting visitor:', error);
                alert('Error disconnecting visitor');
            }
        },
        
        async deleteMessage(messageId) {
            if (!messageId) return;
            try {
                const response = await fetch(`/admin/chat/message/${messageId}/delete`, {
                    method: 'POST'
                });
                if (response.ok) {
                    console.log('Message deleted');
                } else {
                    alert('Failed to delete message');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message');
            }
        },
        
        async clearChatHistory() {
            if (!confirm('Clear all chat history? This cannot be undone.')) return;
            try {
                const response = await fetch('/admin/chat/clear', {
                    method: 'POST'
                });
                if (response.ok) {
                    console.log('Chat history cleared');
                } else {
                    alert('Failed to clear chat history');
                }
            } catch (error) {
                console.error('Error clearing chat:', error);
                alert('Error clearing chat history');
            }
        }
    }
}
</script>
{% endblock %}