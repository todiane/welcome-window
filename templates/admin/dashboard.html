{% extends "base.html" %}
{% block body %}
<div class="min-h-screen bg-gray-50" x-data="{status:'{{ status.status }}',statusMessage:'{{ status.message }}',activeCount:{{ active_count }}}" x-init="const s=io();s.emit('join_admin');s.on('visitor_joined',(d)=>activeCount=d.count);s.on('visitor_left',(d)=>activeCount=d.count)">
    <div class="bg-white border-b px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Admin Dashboard</h1>
            <div class="flex gap-3">
                <a href="/" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">View Site</a>
                <a href="/admin/logout" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</a>
            </div>
        </div>
    </div>
    <div class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Active Visitors</div>
                <div class="text-3xl font-bold" x-text="activeCount"></div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Unread Messages</div>
                <div class="text-3xl font-bold">{{ unread_count }}</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Total Visits</div>
                <div class="text-3xl font-bold">{{ stats.total_visits }}</div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <div class="text-sm text-gray-500">Avg Duration</div>
                <div class="text-3xl font-bold">{{ stats.avg_duration_minutes }}m</div>
            </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Availability Status</h2>
            <div class="flex gap-4 mb-4">
                <button @click="status='available';statusMessage='Available for a chat!';fetch('/admin/status/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:status,message:statusMessage})})" :class="status==='available'?'bg-green-600 text-white':'bg-gray-200'" class="px-6 py-3 rounded-lg font-medium">Available</button>
                <button @click="status='busy';statusMessage='Busy right now';fetch('/admin/status/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:status,message:statusMessage})})" :class="status==='busy'?'bg-yellow-600 text-white':'bg-gray-200'" class="px-6 py-3 rounded-lg font-medium">Busy</button>
                <button @click="status='away';statusMessage='Not available';fetch('/admin/status/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:status,message:statusMessage})})" :class="status==='away'?'bg-red-600 text-white':'bg-gray-200'" class="px-6 py-3 rounded-lg font-medium">Away</button>
            </div>
            <div>
            <label class="block text-sm font-medium mb-2">Status Message</label>
            <input type="text" x-model="statusMessage" @keyup.enter="fetch('/admin/status/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:status,message:statusMessage})})" class="w-full px-4 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none">
            <button @click="fetch('/admin/status/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:status,message:statusMessage})})" class="mt-3 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save Status</button>
        </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl p-6 shadow">
                <h2 class="text-xl font-bold mb-4">Guest Book</h2>
                <div class="space-y-3">
                    {% for msg in messages %}
                    <div class="border rounded-lg p-4 {% if not msg.is_read %}bg-blue-50{% endif %}">
                        <div class="flex justify-between mb-2">
                            <div class="font-medium">{{ msg.visitor_name or 'Anonymous' }}</div>
                            <div class="text-xs text-gray-500">{{ msg.created_at }}</div>
                        </div>
                        <div class="text-gray-700">{{ msg.message }}</div>
                        {% if not msg.is_read %}
                        <button onclick="fetch('/admin/messages/{{ msg.id }}/read',{method:'POST'}).then(()=>window.location.reload())" class="text-xs text-blue-600 mt-2 hover:underline">Mark read</button>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">No messages yet</div>
                    {% endfor %}
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow">
                <h2 class="text-xl font-bold mb-4">Recent Visits</h2>
                <div class="space-y-3">
                    {% for visit in visits %}
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between mb-1">
                            <div class="font-medium">{{ visit.visitor_name or 'Anonymous' }}</div>
                            <div class="text-xs text-gray-500">
                                {% if visit.duration_seconds %}{{ (visit.duration_seconds/60)|round(1) }}m{% else %}Active{% endif %}
                            </div>
                        </div>
                        <div class="text-sm text-gray-600">{{ visit.started_at }}</div>
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">No visits yet</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}