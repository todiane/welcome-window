{% extends "base.html" %}
{% block extra_head %}
<script src="/static/js/wordsearch.js"></script>
<script src="/static/js/sudoku.js"></script>
<script src="/static/js/trivia.js"></script>
<script src="/static/js/chess.js"></script>

{% endblock %}
{% block body %}
<div class="min-h-screen bg-gray-900 text-white" x-data="chatRoom()" x-init="init()">
    <div class="bg-gray-800 px-6 py-4 border-b border-gray-700">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">The Welcome Window</h1>
                <p class="text-sm text-gray-400">Connected as {{ visitor_name }}</p>
            </div>
            <div class="flex gap-2">
                <a href="/room/video" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Switch to Video</a>
                <button @click="if(confirm('Leave the chat?')){window.location.href='/'}" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">Exit</button>
            </div>
        </div>
    </div>
    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div x-show="!currentGame" class="bg-gray-800 rounded-xl p-12 text-center">
                <div class="text-6xl mb-4">ðŸ‘‹</div>
                <h2 class="text-2xl font-bold mb-2">Welcome To Customer Support</h2>
                <p class="text-gray-400 mb-6">Waiting? Why not play a game.</p>
                <div class="grid grid-cols-2 gap-3 max-w-md mx-auto">
                    <button @click="loadGame('wordsearch')" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">Word Search</button>
                    <button @click="loadGame('sudoku')" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">Sudoku</button>
                    <button @click="loadGame('trivia')" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">Trivia</button>
                    <a href="https://djangify.com/docs" target="_blank" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm text-center block">Documentation</a>
                </div>
            </div>
            <div x-show="currentGame" class="bg-gray-800 rounded-xl p-6">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold" x-text="currentGame=='wordsearch'?'Word Search':currentGame=='sudoku'?'Sudoku':currentGame=='trivia'?'Trivia Quiz':'Chess'"></h2>
                    <button @click="currentGame=null" class="px-3 py-1 bg-gray-700 rounded-lg text-sm">Close</button>
                </div>
                <div id="game-container" class="text-white"></div>
            </div>
        </div>
        <div class="lg:col-span-1">
            <div class="bg-gray-800 rounded-xl flex flex-col h-[600px]">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="font-bold text-lg">Chat</h2>
                    <p class="text-xs text-gray-400" x-show="connected">âœ“ Connected</p>
                    <p class="text-xs text-red-400" x-show="!connected">â—‹ Disconnected</p>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3" id="messages">
                    <template x-for="(msg, index) in messages" :key="msg.id || index">
                        <div :class="msg.sender==='admin'?'text-right':'text-left'">
                            <div class="inline-block max-w-[80%]">
                                <div class="text-xs text-gray-400 mb-1" x-text="msg.sender_name"></div>
                                <div class="px-3 py-2 rounded-lg break-words" :class="msg.sender==='admin'?'bg-blue-600 text-white':'bg-gray-700 text-white'" x-text="msg.message"></div>
                                <div class="text-xs text-gray-500 mt-1" x-text="msg.created_at ? new Date(msg.created_at).toLocaleTimeString() : new Date(msg.timestamp).toLocaleTimeString()"></div>
                            </div>
                        </div>
                    </template>
                    <div x-show="messages.length === 0" class="text-center text-gray-400 py-12">
                        No messages yet. Say hello!
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700">
                    <form @submit.prevent="sendMessage()">
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                x-model="currentMessage" 
                                placeholder="Type a message..." 
                                class="flex-1 px-4 py-2 bg-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                :disabled="!connected"
                            >
                            <button 
                                type="submit" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="!currentMessage.trim() || !connected"
                            >
                                Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function chatRoom(){
    return {
        currentGame: null,
        messages: [],
        currentMessage: '',
        socket: null,
        connected: false,
        messageCounter: 0,
        
        init() {
            console.log('Initializing chat room...');
            
            this.socket = io();
            
            this.socket.on('connect', () => {
                console.log('Socket connected');
                this.connected = true;
            });
            
            this.socket.on('disconnect', () => {
                console.log('Socket disconnected');
                this.connected = false;
            });
            
            this.socket.on('connection_established', (data) => {
                console.log('Connection established:', data);
                
                // Load chat history
                if (data.chat_history && data.chat_history.length > 0) {
                    this.messages = data.chat_history.map((msg) => ({
                        id: msg.id,
                        message: msg.message,
                        sender: msg.sender,
                        sender_name: msg.sender_name,
                        timestamp: msg.created_at,
                        created_at: msg.created_at
                    }));
                    
                    // Scroll to bottom
                    this.$nextTick(() => {
                        const container = document.getElementById('messages');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                }
            });
            
            this.socket.on('new_message', (data) => {
                console.log('New message received:', data);
                
                // Add message to array
                this.messages.push({
                    id: data.id || this.messageCounter++,
                    message: data.message,
                    sender: data.sender,
                    sender_name: data.sender_name,
                    timestamp: data.timestamp,
                    created_at: data.timestamp
                });
                
                // Scroll to bottom
                this.$nextTick(() => {
                    const container = document.getElementById('messages');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                });
            });
            
            // Handle forced disconnect from admin
            this.socket.on('force_disconnect', (data) => {
                alert(data.reason || 'You have been disconnected by the admin');
                window.location.href = '/';
            });
            
            // Handle message deletion
            this.socket.on('message_deleted', (data) => {
                this.messages = this.messages.filter(msg => msg.id !== data.message_id);
            });
            
            // Handle chat cleared
            this.socket.on('chat_cleared', () => {
                this.messages = [];
            });
            
            // Poll for new messages as fallback
            setInterval(async () => {
                try {
                    const response = await fetch('/api/chat/messages');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.length !== this.messages.length) {
                            this.messages = data;
                            this.$nextTick(() => {
                                const container = document.getElementById('messages');
                                if (container) container.scrollTop = container.scrollHeight;
                            });
                        }
                    }
                } catch (e) {}
            }, 2000);
        },
        
        sendMessage() {
            if (!this.currentMessage.trim() || !this.connected) return;
            
            console.log('Sending message:', this.currentMessage);
            
            this.socket.emit('send_message', {
                message: this.currentMessage,
                sender: 'visitor'
            });
            
            this.currentMessage = '';
        },
        
        loadGame(game) {
            this.currentGame = game;
            setTimeout(() => {
                if (game === 'wordsearch') {
                    window.initWordSearch('game-container');
                } else if (game === 'sudoku') {
                    window.initSudoku('game-container');
                } else if (game === 'trivia') {
                    window.initTrivia('game-container');
                } else if (game === 'chess') {
                    window.initChess('game-container');
                }
            }, 100);
        }
    }
}
</script>
{% endblock %}